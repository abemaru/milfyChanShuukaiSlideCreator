# スライドエディターアプリ - 基本設計書

## プロジェクト概要

ミルフィちゃん集会用のスライド作成Webアプリケーション。
ユーザーは背景画像を元に、PNG画像とテキストを自由に配置してスライドを作成できる。

### 主要機能
1. 背景画像の表示(固定)
2. PNG画像のアップロードと配置
3. テキストの追加と編集
4. オブジェクト(画像・テキスト)のドラッグ移動・リサイズ
5. 完成したスライドのエクスポート(PNG/JPG)

## 技術スタック

### フロントエンド
- **React 18** (TypeScript)
- **Vite** (ビルドツール)
- **Fabric.js 5.x** (キャンバス操作ライブラリ)
- **Tailwind CSS** (スタイリング)

### デプロイ
- **GitHub Pages** (静的ホスティング)
- GitHub Actions (自動デプロイ)

## ディレクトリ構成

```
slide-editor/
├── public/
│   └── background.png          # デフォルト背景画像
├── src/
│   ├── components/
│   │   ├── Canvas.tsx          # Fabric.jsキャンバスコンポーネント
│   │   ├── Toolbar.tsx         # ツールバー(画像追加・テキスト追加・エクスポート)
│   │   └── PropertyPanel.tsx  # 選択中オブジェクトのプロパティ編集
│   ├── hooks/
│   │   └── useFabricCanvas.ts # Fabric.js操作のカスタムフック
│   ├── types/
│   │   └── fabric.d.ts        # Fabric.js型定義拡張
│   ├── utils/
│   │   ├── canvas.ts          # キャンバス操作ユーティリティ
│   │   └── export.ts          # エクスポート処理
│   ├── App.tsx
│   ├── main.tsx
│   └── index.css
├── package.json
├── tsconfig.json
├── vite.config.ts
├── tailwind.config.js
└── README.md
```

## 機能詳細仕様

### 1. キャンバス初期化
- キャンバスサイズ: 1600px × 900px (16:9)
- 背景画像: `/background.png` を固定表示
- 背景は選択不可、ドラッグ不可

### 2. PNG画像の追加
**トリガー**: ツールバーの「画像追加」ボタン
**処理フロー**:
1. `<input type="file" accept="image/png">` で画像選択
2. FileReaderでDataURL取得
3. Fabric.Image.fromURL()でキャンバスに追加
4. 初期配置: キャンバス中央
5. 初期サイズ: 元画像の50%スケール

**制約**:
- PNG形式のみ受付
- 最大ファイルサイズ: 5MB
- 追加できる画像数: 制限なし

### 3. テキストの追加
**トリガー**: ツールバーの「テキスト追加」ボタン
**処理フロー**:
1. fabric.IText でテキストオブジェクト作成
2. デフォルトテキスト: "テキストを入力"
3. 初期配置: キャンバス中央
4. ダブルクリックで編集モード

**デフォルトスタイル**:
```typescript
{
  fontSize: 48,
  fontFamily: 'Arial, sans-serif',
  fill: '#000000',
  fontWeight: 'normal',
  textAlign: 'left'
}
```

### 4. オブジェクト操作

#### ドラッグ移動
- 全オブジェクト(画像・テキスト)がドラッグ可能
- 背景画像のみドラッグ不可

#### リサイズ
- コーナーハンドルでアスペクト比保持リサイズ
- 画像: 最小サイズ 50px × 50px
- テキスト: フォントサイズ 12px ~ 200px

#### 削除
- 選択中オブジェクトを「Delete」キーで削除
- または削除ボタンクリック

#### レイヤー順序
- 前面へ移動 (Bring to Front)
- 背面へ移動 (Send to Back)

### 5. プロパティ編集パネル

選択中のオブジェクトのプロパティを編集可能:

**テキストオブジェクト**:
- フォントサイズ (スライダー: 12-200)
- フォントカラー (カラーピッカー)
- フォントウェイト (normal / bold)
- テキスト整列 (left / center / right)

**画像オブジェクト**:
- 不透明度 (スライダー: 0-100%)
- 回転角度 (スライダー: 0-360度)

### 6. エクスポート機能

**トリガー**: ツールバーの「エクスポート」ボタン

**処理フロー**:
1. `canvas.toDataURL('image/png')` でDataURL取得
2. Blobに変換
3. `<a>` タグで自動ダウンロード
4. ファイル名: `slide_${timestamp}.png`

**オプション**:
- PNG形式 (デフォルト、透過対応)
- JPG形式 (背景白、ファイルサイズ小)

## 実装の重要ポイント

### Fabric.jsの初期化

```typescript
// useFabricCanvas.ts
import { useEffect, useRef, useState } from 'react';
import { fabric } from 'fabric';

export const useFabricCanvas = () => {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [canvas, setCanvas] = useState<fabric.Canvas | null>(null);

  useEffect(() => {
    if (!canvasRef.current) return;

    const fabricCanvas = new fabric.Canvas(canvasRef.current, {
      width: 1600,
      height: 900,
      backgroundColor: '#ffffff',
      selection: true,
    });

    // 背景画像の設定
    fabric.Image.fromURL('/background.png', (img) => {
      img.scaleToWidth(1600);
      img.scaleToHeight(900);
      fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas), {
        originX: 'left',
        originY: 'top',
      });
    });

    setCanvas(fabricCanvas);

    return () => {
      fabricCanvas.dispose();
    };
  }, []);

  return { canvas, canvasRef };
};
```

### 画像追加の実装

```typescript
// utils/canvas.ts
export const addImageToCanvas = (
  canvas: fabric.Canvas,
  imageFile: File
): Promise<void> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      const dataUrl = e.target?.result as string;
      
      fabric.Image.fromURL(dataUrl, (img) => {
        img.scale(0.5);
        img.set({
          left: canvas.width! / 2 - (img.width! * 0.5) / 2,
          top: canvas.height! / 2 - (img.height! * 0.5) / 2,
        });
        
        canvas.add(img);
        canvas.setActiveObject(img);
        canvas.renderAll();
        resolve();
      }, {
        crossOrigin: 'anonymous'
      });
    };
    
    reader.onerror = reject;
    reader.readAsDataURL(imageFile);
  });
};
```

### テキスト追加の実装

```typescript
export const addTextToCanvas = (canvas: fabric.Canvas): void => {
  const text = new fabric.IText('テキストを入力', {
    left: canvas.width! / 2 - 100,
    top: canvas.height! / 2 - 25,
    fontSize: 48,
    fill: '#000000',
    fontFamily: 'Arial',
  });
  
  canvas.add(text);
  canvas.setActiveObject(text);
  canvas.renderAll();
};
```

### エクスポートの実装

```typescript
// utils/export.ts
export const exportCanvas = (
  canvas: fabric.Canvas,
  format: 'png' | 'jpeg' = 'png'
): void => {
  const dataUrl = canvas.toDataURL({
    format,
    quality: 1,
    multiplier: 1,
  });
  
  const link = document.createElement('a');
  link.download = `slide_${Date.now()}.${format}`;
  link.href = dataUrl;
  link.click();
};
```

## UIデザイン指針

### レイアウト
```
+--------------------------------------------------+
|  Toolbar (上部固定)                               |
|  [画像追加] [テキスト追加] [エクスポート▼]         |
+--------------------------------------------------+
|           |                                       |
|  Property |         Canvas                        |
|  Panel    |         (1600x900)                   |
|  (左側)   |                                       |
|  200px    |                                       |
|           |                                       |
+--------------------------------------------------+
```

### カラースキーム
- 背景: `#f5f5f5` (薄いグレー)
- ツールバー: `#ffffff` (白)
- アクセントカラー: ミルフィちゃんのイメージカラーに合わせる
- ボタン: 角丸、影付き

### レスポンシブ対応
- デスクトップのみ対応(1280px以上推奨)
- キャンバスは固定サイズ、スクロール可能
- モバイルでの使用は非推奨メッセージ表示

## パッケージ依存関係

```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "fabric": "^5.3.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "@vitejs/plugin-react": "^4.2.0",
    "typescript": "^5.3.0",
    "vite": "^5.0.0",
    "tailwindcss": "^3.4.0",
    "autoprefixer": "^10.4.0",
    "postcss": "^8.4.0"
  }
}
```

## GitHub Pages デプロイ設定

### vite.config.ts
```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  base: '/slide-editor/', // GitHubリポジトリ名に合わせる
  build: {
    outDir: 'dist',
  },
});
```

### GitHub Actions ワークフロー
`.github/workflows/deploy.yml`

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Build
        run: npm run build
        
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
```

## 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build

# プレビュー
npm run preview

# 型チェック
npm run type-check
```

## テスト項目

### 基本動作
- [ ] 背景画像が正しく表示される
- [ ] PNG画像がアップロード・追加できる
- [ ] テキストが追加できる
- [ ] オブジェクトがドラッグ移動できる
- [ ] オブジェクトがリサイズできる
- [ ] オブジェクトが削除できる
- [ ] エクスポートが正常に動作する

### エッジケース
- [ ] 大きな画像(5MB以上)をアップロードした場合のエラーハンドリング
- [ ] PNG以外の画像形式をアップロードした場合のエラーメッセージ
- [ ] テキストが空の場合の処理
- [ ] キャンバス外にオブジェクトを配置した場合の挙動

## 今後の拡張案

- 複数ページ対応(スライドのページ送り)
- テンプレート機能
- オブジェクトのグループ化
- アンドゥ/リドゥ機能
- キーボードショートカット
- 画像フィルター(明度・彩度調整)
- ローカルストレージに作業中データを保存

## 参考資料

- [Fabric.js Documentation](http://fabricjs.com/docs/)
- [Fabric.js Examples](http://fabricjs.com/demos/)
- [Vite Guide](https://vitejs.dev/guide/)
- [GitHub Pages Deployment](https://vitejs.dev/guide/static-deploy.html#github-pages)
